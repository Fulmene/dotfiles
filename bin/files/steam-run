#!/bin/bash

# Initialise
runtime=0
native=0
wine=0

# Parse arguments
while [[ $# -gt 0 ]]; do
    key=$1
    case "$key" in
        -r|--runtime)
            runtime=1
            ;;
        -n|--native)
            native=1
            ;;
        -w|--wine)
            wine=1
            ;;
        -*)
            echo "Error: Unrecognised option ${key}." >&2
            ;;
        *)
            if [[ "$key" -lt 0 ]]; then
                echo "Error: Game ID must be non-negative integer." >&2
                exit 1
            elif [[ -n "$game_id" ]]; then
                echo "Error: Multiple game ID present." >&2
                exit 1
            else
                game_id=$key
            fi
            ;;
    esac
    shift
done

steam_process_name="steam"
steam_other_process_name="Steam.exe"
steam_command="steam"
steam_run_command="steam"

if [[ $(($runtime+$native+$wine)) -lt 1 ]]; then
    echo "Error: No options specified." >&2
    exit 1
elif [[ $(($runtime+$native+$wine)) -gt 1 ]]; then
    echo "Error: Multiple options specified." >&2
    exit 1
elif [[ "$wine" -eq 1 ]]; then
    export WINEPREFIX=~/.wine/steam
    export FREETYPE_PROPERTIES="truetype:interpreter-version=35"
    steam_process_name="Steam.exe"
    steam_other_process_name="steam"
    steam_command="wine 'C:\\Program Files\\Steam\\Steam.exe' -no-cef-sandbox"
    steam_run_command="wine start"
elif [[ "$native" -eq 1 ]]; then
    steam_process_name="steam"
    steam_command="steam-native"
    steam_run_command="steam-native"
fi

if ! pgrep --exact "$steam_process_name"; then # &> /dev/null; then
    echo "not grepped"
    pkill --exact "$steam_other_process_name" # &> /dev/null
    while pgrep --exact "$steam_other_process_name"; do # &> /dev/null; do
        sleep 0.1
    done
    $steam_command
fi

if [[ -n "$game_id" ]]; then
    $steam_run_command "steam://rungameid/${game_id}"
fi

